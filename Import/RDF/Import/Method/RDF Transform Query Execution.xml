<AML>
 <Item type="Method" id="BC9CF075268043E889291F09F5946016" action="add">
  <comments>Converts Query Definition result to JSON-LD</comments>
  <execution_allowed_to keyed_name="World" type="Identity">A73B655731924CD0B027E4F4D5FCC0A9</execution_allowed_to>
  <method_code><![CDATA[string XSLT_PATH = CCO.Server.MapPath("../Client/customer/transform-qd-result.xsl");
Innovator inn = this.getInnovator();
XmlDocument doc = new XmlDocument();
string qd_id = this.getProperty("qd_id","");
//qd_id = "467143F3250D42CF9D2F6F880ABD3999"; // for testing

// get query definition with relationships
Item queryDef = inn.newItem("qry_QueryDefinition","get");
queryDef.setID(qd_id);
queryDef.setAttribute("levels","2");
queryDef = queryDef.apply();

// get top-level query item (context item)                  
string offset = "0";
string fetch = "1";
string offset_fetch = @"<configuration><option><offset>" + offset + 
                    "</offset><fetch>" + fetch + 
                    "</fetch></option></configuration>";

XmlNode rootItem = queryDef.dom.SelectSingleNode("//Item[@type='qry_QueryDefinition']/Relationships/Item[1]");
XmlCDataSection cdata = queryDef.dom.CreateCDataSection(offset_fetch);
XmlElement newNode = queryDef.dom.CreateElement("offset_fetch_xml");
newNode.AppendChild(cdata);

// execute query
queryDef.setAction("qry_ExecuteQueryDefinition");
queryDef.setAttribute("levels","0");
queryDef = queryDef.apply();

string xml = queryDef.ToString();
XmlDocument resDoc = new XmlDocument();
resDoc.LoadXml(xml);

// Load the style sheet.
XslCompiledTransform xslt = new XslCompiledTransform();
xslt.Load(XSLT_PATH);

// Create the writer.
StringWriter writer = new StringWriter();

// Execute the transformation.
xslt.Transform(resDoc.CreateNavigator(),null, writer);
string newxml = writer.ToString();

XmlDocument newdoc = new XmlDocument();
newdoc.LoadXml(newxml);

string result = JsonConvert.SerializeXmlNode(newdoc);

return inn.newResult(result); // return JSON
//return inn.newResult(newxml); // for testing - transformed XML
//return inn.newResult(xml); // for testing - initial XML]]></method_code>
  <method_type>C#</method_type>
  <name>RDF Transform Query Execution</name>
 </Item>
</AML>